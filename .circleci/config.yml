global: &global
    environment:
        MAJOR_VERSION: 0
        MINOR_VERSION: 0
        PACKAGE_FULL_VERSION: "{{ .Environment.MAJOR_VERSION }}.{{ .Environment.MINOR_VERSION }}.{{ .BuildNum }}"
        PACKAGE_NAME: helloworld-{{ .Environment.PACKAGE_FULL_VERSION }}-Linux.deb
    docker:
        - image: podshivalovilya/cppbuilder:latest
    working_directory: /usr/local/src

version: 2
jobs:
    build:
        <<: *global
        steps:
            - checkout
            - run:
                name: "CMake project"
                command: "cmake ."
            - run:
                name: "Building"
                command: "cmake --build ."
            - run:
                name: "Running tests"
                command: "cmake --build . --target test"
            - run:
                name: "Running packaging"
                command: "cmake --build . --target package"
            - store_artifacts:
                path: ./*.deb
    deploy:
        <<: *global
        steps:
            - run:
                name: "Deploying to bintray"
                command: |
                    echo ${PACKAGE_NAME}
workflows:
    version: 2
    build_deploy:
        jobs:
            - build
            - deploy:
                requires:
                    - build
                filters:
                    branches:
                        only: /master$/
